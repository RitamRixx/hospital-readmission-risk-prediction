stages:

  data_ingestion:
    cmd: python -m src.data.data_ingestion
    deps:
      - src/data/data_ingestion.py
      - src/db/engine.py
    params:
      - database
      - data.data_version
      - paths.raw_data
    outs:
      - data/raw/raw.csv

  data_cleaning:
    cmd: python -m src.data.data_cleaning
    deps:
      - src/data/data_cleaning.py
      - data/raw/raw.csv
    outs:
      - data/interim/cleaned_data.csv

  feature_engineering:
    cmd: python -m src.features.feature_engineering
    deps:
      - src/features/feature_engineering.py
      - data/interim/cleaned_data.csv
    outs:
      - data/processed/featured_data.csv
      - models/feature_info.json

  drift_check:
    cmd: python -m src.monitoring.data_drift
    deps:
      - src/monitoring/data_drift.py
      - data/processed/featured_data.csv
      - data/reference/reference_data.csv
    params:
      - drift_monitoring
      - paths.featured_data
      - paths.reference_data
    outs:
      - models/drift_decision.json
      - models/drift_report:
          cache: false

  data_split:
    cmd: python -m src.features.data_split
    deps:
      - src/features/data_split.py
      - data/processed/featured_data.csv
    outs:
      - data/final/train.csv
      - data/final/test.csv

  training_eval:
    cmd: python -m src.model.training_eval
    deps:
      - src/model/training_eval.py
      - data/final/train.csv
      - data/final/test.csv
    outs:
      - models/model_candidate.pkl
      - models/candidate_label_encoders.pkl
      - models/candidate_target_encoder.pkl
      - models/metrics/candidate_evaluation.json

  model_compare:
    cmd: python -m src.model.model_compare
    deps:
      - src/model/model_compare.py
      - models/model_candidate.pkl
      - data/final/test.csv
    params:
      - model_comparison
      - encoding
      - feature_engineering.target
    outs:
      - models/deployment_decision.json

  register_model:
    cmd: python -m src.model.register_model
    deps:
      - src/model/register_model.py
      - models/model.pkl
      - models/metrics/evaluation.json
    params:
      - mlflow