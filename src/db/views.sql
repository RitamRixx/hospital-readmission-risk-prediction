
CREATE OR REPLACE VIEW hospital_data_flattened AS
SELECT 
    id,
    ingest_at,
    payload->>'encounter_id' as encounter_id,
    payload->>'patient_nbr' as patient_nbr,
    payload->>'race' as race,
    payload->>'gender' as gender,
    payload->>'age' as age,
    payload->>'weight' as weight,
    
    CAST(payload->>'admission_type_id' AS INTEGER) as admission_type_id,
    CAST(payload->>'discharge_disposition_id' AS INTEGER) as discharge_disposition_id,
    CAST(payload->>'admission_source_id' AS INTEGER) as admission_source_id,
    CAST(payload->>'time_in_hospital' AS INTEGER) as time_in_hospital,
    payload->>'payer_code' as payer_code,
    payload->>'medical_specialty' as medical_specialty,
    
    CAST(payload->>'num_lab_procedures' AS INTEGER) as num_lab_procedures,
    CAST(payload->>'num_procedures' AS INTEGER) as num_procedures,
    CAST(payload->>'num_medications' AS INTEGER) as num_medications,
    CAST(payload->>'number_outpatient' AS INTEGER) as number_outpatient,
    CAST(payload->>'number_emergency' AS INTEGER) as number_emergency,
    CAST(payload->>'number_inpatient' AS INTEGER) as number_inpatient,
    CAST(payload->>'number_diagnoses' AS INTEGER) as number_diagnoses,
    
    payload->>'diag_1' as diag_1,
    payload->>'diag_2' as diag_2,
    payload->>'diag_3' as diag_3,
    
    payload->>'max_glu_serum' as max_glu_serum,
    payload->>'A1Cresult' as A1Cresult,
    payload->>'metformin' as metformin,
    payload->>'repaglinide' as repaglinide,
    payload->>'nateglinide' as nateglinide,
    payload->>'chlorpropamide' as chlorpropamide,
    payload->>'glimepiride' as glimepiride,
    payload->>'acetohexamide' as acetohexamide,
    payload->>'glipizide' as glipizide,
    payload->>'glyburide' as glyburide,
    payload->>'tolbutamide' as tolbutamide,
    payload->>'pioglitazone' as pioglitazone,
    payload->>'rosiglitazone' as rosiglitazone,
    payload->>'acarbose' as acarbose,
    payload->>'miglitol' as miglitol,
    payload->>'troglitazone' as troglitazone,
    payload->>'tolazamide' as tolazamide,
    payload->>'examide' as examide,
    payload->>'citoglipton' as citoglipton,
    payload->>'insulin' as insulin,
    payload->>'glyburide-metformin' as glyburide_metformin,
    payload->>'glipizide-metformin' as glipizide_metformin,
    payload->>'glimepiride-pioglitazone' as glimepiride_pioglitazone,
    payload->>'metformin-rosiglitazone' as metformin_rosiglitazone,
    payload->>'metformin-pioglitazone' as metformin_pioglitazone,
    
    payload->>'change' as change,
    payload->>'diabetesMed' as diabetesMed,
    payload->>'readmitted' as readmitted
FROM raw_hospital_data;